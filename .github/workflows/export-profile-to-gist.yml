name: Export profile to gist

on:
  # checkov:skip=CKV_GHA_7: workflow_dispatch inputs are intentional for selecting profile slugs/gists.
  workflow_dispatch:
    inputs:
      slug:
        description: Profile slug to export (e.g., fullstack-js-ts)
        required: true
        type: string
      gist_id:
        description: Optional existing secret gist ID to overwrite (expects a .code-profile payload)
        required: false
        type: string

permissions:
  contents: read

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Locate code-profile export
        id: profile
        run: |
          file="vscode/profiles-dist/${{ inputs.slug }}.code-profile"
          if [ ! -f "$file" ]; then
            echo "::error::Missing $file. Export it from VS Code via 'Export Profileâ€¦' first." >&2
            exit 1
          fi
          echo "file=$file" >> "$GITHUB_OUTPUT"

      - name: Upload code-profile artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.slug }}-code-profile
          path: ${{ steps.profile.outputs.file }}
          if-no-files-found: error

      - name: Publish to secret gist (code-profile)
        if: env.GIST_TOKEN != '' && inputs.gist_id != ''
        uses: exuanbo/actions-deploy-gist@47697fceaeea2006a90594ee24eb9cd0a1121ef8 # v1.1.4
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        with:
          token: ${{ secrets.GIST_TOKEN }}
          gist_id: ${{ inputs.gist_id }}
          file_path: ${{ steps.profile.outputs.file }}
          file_type: text
